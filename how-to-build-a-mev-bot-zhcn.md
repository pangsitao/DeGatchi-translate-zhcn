原文：https://degatchi.com/articles/how-to-build-a-mev-bot

原文日期：Setp. 2022

MEV: 矿工可攫取价值/验证者可攫取价值，矿工/验证者可以通过安排区块内各个交易的顺序来获得的利润，其中最被大众所知晓的典型MEV机器人就是三明治攻击抢跑机器人。

# 如何构建一个MEV Bot
___

如果你厌倦了一直打PvE，想尝试玩一下PvP；那么新手，你要注意了，你将要面对一个孤独的处境。为了让你的武器一直锋利，你将不得不一直花成吨的时间维护更新它，除非你发现的是一个相当小众的策略。但是俗话说，风浪越大鱼越贵！如果你认同这话，那就继续往下看。

## 找到一个策略

链上有许多和你一样想搞钱的玩家，他们就像是潜伏着等待猎物的猎人，你现在必须和他们一较高下了，那么你必须要有个确实能搞到钱的策略。
那么怎么搞？
你其实有两个选择：抄别人的策略 或者 找到你自己的策略。

#### 抄别人的策略
想抄，那你也得先找的到。当然你可以去区块链浏览器上查看区块，在每个区块里的每条交易查找，要看每条交易报出的是什么事件，都和哪些合约交互的，这样你才能获悉到这个策略是怎么玩的。或者呢，你可以试试三大传统项目：清算攻击、套利攻击、三明治攻击。

一直观察区块浏览器然后从中学到一个策略其实才是最简单的办法，因为你找到的这个策略很可能只被很少的猎人所掌握的。如果你嫌累不想这么干，那么你要面对的将是一场和其他猎人你追我赶的局面，而且要知道，那些比你先到场的猎人已经装备好了最锋利的武器来迎接你了。

#### 属于自己的策略

如果你既没有团队，又不想和其他猎人在这场关于如何极致优化自己武器的游戏里决斗，你得想想怎么样用其他猎人都还没有想过的方式，去操控交易流来获利。通常这样才能干一票大的，当然，你只要是干到一票，别人就会在区块浏览器里发现你，然后抄你的策略干你一样的事，然后又进入军备竞赛。

有许多链，链上又有许多的协议应用，有些协议应用是独家在某条链上，也有的是部署在多条链上。要我说，想要找到属于你自己的策略，最好去找那些独家部署的协议下手，因为多链部署的协议的代码通常都被研究的透透的，很难了。

然后你要合约层面上知晓这些目标应用到底是怎么工作的，明白函数之间怎么交互的、又会引起哪些状态改变、又是怎么改变的。然后你想想有没有什么办法破解这个被改变的状态，怎么布置这些函数调用来搞钱。

举个例子，假如有两条路径可以买代币，第一条路里，猎物买代币的行为导致价格改变了，但是第二条路里价格还没被影响，那么你可以在第二条路里卖币，在第一条路里买回来。

就这么说，在这里，你只要脑洞够大，你就能搞到钱！

为什么这么说？

如果你想到了一条别人没想到的办法，意味着没人和你竞争！那你的武器都不需要优化。而且如果你后面保持迭代优化，就算有人发现了你的策略，也没人能追的上你！


## 开发Bot

默认你找到你的策略了。准备实现它吧。在构建系统实现你的策略之前，你脑子一定要清楚一点：只创建一个最简单的系统、以后有的是时间迭代优化它。否则你完不成又有什么用。

因为，在你部署系统前的每分每秒里，其他猎人都可能：
* 和你一样偶然发现了这个策略
* 正在写代码实现这个策略
* 正要搞钱了

我推荐用Rust语言，性能和安全都强，你喜欢别的你用别的也行，反正就一个要点，你只要能比别的猎人快就是好的。同样的实现，一个Typescript机器人打不过一个Rust机器人。

一个MEV机器人（不包括基础设施）一般大概80%是监控系统，20%是合约，占比也取决于你的策略会有不同，不过完全没有监控系统就只有合约，那样是搞不到钱的，因为合约都没机会用啊。

所以呢，你得构建一个基础的监控系统，你的合约用来抓取执行链上数据。

我列出来一些核心概念帮你理解一个MEV机器人的结构：

#### 定制的合约

这里是你和区块链交互的地方。如果你需要获取多个合约的状态，最好有一个批量调用函数，利用`array`来最小化链上调用的数量。一旦发现机会了，这里也是你的策略逻辑得以执行的地方。

#### 储存变量

一个跟踪区块链状态的内部全局变量，这是我们优化系统的办法。计算放在链上太慢了。确保你是多线程存储变量，比如在Rust里用`Arc`，你可以同时执行不同的动作。

#### 交易模拟器

变量更新的时候，你的策略是否能够检测到机会搞到钱。你可以创建一个模拟环境来测试，模拟交易。如果你发现有利可图，就广播这个tx，把你的宝贝塞进mempool。如果不呢，就放弃等待下一个。

#### 交易传播系统

就是个基础的RPC提供商，不能指望他来做抢跑。为了做抢跑，你得有一个基础设施，让你很快可以把交易提交到区块链上，尤其是那些爆块很快的链。

#### 多线程

多线程可以并行执行多个任务（不同线程之间不保证顺序执行）。

通常最少2个运行的线程，但如果需要的话也可能更多。

举个例子，第一个线程可能是用于：

* 调用 view 类型的函数，最简单的从链上抓数据的方法。
* 或者订阅 event 流来更新我们的变量以保持和线上一致。

注意如果用 event 流，那么在mempool txs看了一遍之后，最好每个块都用 view 函数得到区块链的真实状态。（译者没看懂：Keep in mind you use event streams it would also be wise to have the view functions called each block to get the true state after the mempool txs have gone through.）

#### 事件流

用 webhook 你能订阅一个智能合约的流入事件，再用这个事件数据来更新你的全局变量保持在线，例如，当一个人被清算的时候你能更新他们的仓位，不用再去一直尝试调用合约来获取每个仓位了。

#### Mempool流

这里你可以监控那些待上链的交易，使你能够模拟和执行抢跑交易。如果你不想或者不会运行自己的节点（比如GETH），你也能用别人提供的节点服务，自己跑还是成本低些，还可以定制逻辑。

#### 虚拟主机

你要有个地方托管你的机器人，你可以本地运行，但是如果想尽可能优化的话最好用单独专门的机器来托管，这样它能运行的同时不影响你。我只用过亚马逊云，你发现别的好用的也可以，为了效率，尽量让你的托管主机离你的节点近一点。

#### 以后的路

一旦你的机器人开始工作，就只剩下优化了，改善监控、改善成功率。可以增加断路器、代币黑名单、算法优化、代码优化、实现最佳实践、数据结构优化、gas策略优化、所有提到和没提到的。

#### 最后

建一个MEV机器人有很多工作，即便你没赚到钱，你学到的、磨炼了的技术都很有价值，不要小看它。我知道这一路很难，尤其你以前又没有干过，但是谁都是这么过来的，加油老哥。

这是我关于编程的第一个文章，虽然没什么代码，但是我觉得都是对MEV新手来说是最有用的内容。我断断续续花了一年的研究才知道这些概念，我想帮帮那些挣扎的、放弃的、和我曾经一样的人。

谢谢你花时间看我的文章，我希望你能搞到钱，猎人！
